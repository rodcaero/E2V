---
import Layout from '../layouts/Layout.astro';

// Lee todos los archivos .md de la carpeta
const allNews = await Astro.glob('../data/noticias/*.md');

// Ordena las noticias por fecha (la más reciente primero)
const sortedNews = allNews.sort((a, b) => new Date(b.frontmatter.date).valueOf() - new Date(a.frontmatter.date).valueOf());

const featuredNews = sortedNews[0];
const secondaryNews = sortedNews.slice(1);
---

<Layout title="Noticias | E2V Bolivia">
  <main class="news-page">
    
    <section class="news-header">
      <div class="container">
        <div class="header-text">
          <span class="eyebrow">Actualidad Nacional</span>
          <h1>Monitor de Noticias</h1>
          <p class="subtitle">Inteligencia de mercado sobre la transición energética en Bolivia.</p>
        </div>
      </div>
    </section>

    <section class="news-content">
      <div class="container">
        
        {featuredNews && (
          <article class="featured-card">
            <div class="feat-image-wrap">
              <img src={featuredNews.frontmatter.image} alt={featuredNews.frontmatter.title} />
              <span class="category-tag">{featuredNews.frontmatter.category}</span>
            </div>
            <div class="feat-content">
              <span class="date">{featuredNews.frontmatter.date}</span>
              <h2>{featuredNews.frontmatter.title}</h2>
              <p>{featuredNews.frontmatter.description}</p>
              <button class="read-btn open-modal-btn" data-modal={`modal-feat`}>Leer noticia completa &rarr;</button>
            </div>
          </article>
        )}

        <div class="news-grid">
          {secondaryNews.map((news, index) => (
            <article class="news-card">
              <div class="card-image-wrap">
                <img src={news.frontmatter.image} alt={news.frontmatter.title} />
                <span class="category-tag-sm">{news.frontmatter.category}</span>
              </div>
              <div class="card-content">
                <span class="date-sm">{news.frontmatter.date}</span>
                <h3>{news.frontmatter.title}</h3>
                <button class="read-link open-modal-btn" data-modal={`modal-${index}`}>Leer más</button>
              </div>
            </article>
          ))}
        </div>

      </div>
    </section>

  </main>

  {featuredNews && (
    <dialog id="modal-feat" class="news-modal">
      <div class="modal-inner">
        <button class="close-modal-btn">&times; Cerrar</button>
        <img src={featuredNews.frontmatter.image} alt={featuredNews.frontmatter.title} class="modal-img"/>
        <div class="modal-body">
          <span class="date">{featuredNews.frontmatter.date}</span>
          <h2>{featuredNews.frontmatter.title}</h2>
          <div class="prose">
            <Fragment set:html={featuredNews.compiledContent()} />
          </div>
        </div>
      </div>
    </dialog>
  )}

  {secondaryNews.map((news, index) => (
    <dialog id={`modal-${index}`} class="news-modal">
      <div class="modal-inner">
        <button class="close-modal-btn">&times; Cerrar</button>
        <img src={news.frontmatter.image} alt={news.frontmatter.title} class="modal-img"/>
        <div class="modal-body">
          <span class="date">{news.frontmatter.date}</span>
          <h2>{news.frontmatter.title}</h2>
          <div class="prose">
            <Fragment set:html={news.compiledContent()} />
          </div>
        </div>
      </div>
    </dialog>
  ))}
</Layout>

<script>
  // Lógica para abrir y cerrar modales
  const openButtons = document.querySelectorAll('.open-modal-btn');
  const closeButtons = document.querySelectorAll('.close-modal-btn');

  openButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const modalId = btn.getAttribute('data-modal');
      
      // Validamos que modalId no sea null para solucionar el error de TypeScript
      if (modalId) {
        const modal = document.getElementById(modalId) as HTMLDialogElement;
        if (modal) {
          modal.showModal();
          document.body.style.overflow = 'hidden'; // Evita scrollear el fondo
        }
      }
    });
  });

  closeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const modal = btn.closest('dialog');
      if (modal) {
        modal.close();
        document.body.style.overflow = ''; // Restaura el scroll
      }
    });
  });
</script>

<style>
  /* --- BASE Y HEADER (Se mantiene tu CSS original) --- */
  .news-page { background-color: var(--brand-100); min-height: 100vh; padding-bottom: 5rem; }
  .container { max-width: var(--content-max-width, 1200px); margin: 0 auto; padding: 0 1.5rem; }
  .news-header { background-color: var(--brand-800, #1a202c); padding: 4rem 0; color: white; border-bottom: 4px solid var(--cta-main, #f97316); margin-bottom: 3rem; }
  .header-text { text-align: center; }
  .eyebrow { color: var(--cta-main, #f97316); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em; display: block; margin-bottom: 0.5rem; }
  h1 { font-size: clamp(2.5rem, 5vw, 4rem); margin: 0; line-height: 1; text-transform: uppercase; }
  .subtitle { color: #a0aec0; margin-top: 1rem; font-size: 1.1rem; }

  /* --- CARDS (Modificado para usar buttons en lugar de enlaces 'a') --- */
  .featured-card { display: grid; grid-template-columns: 1.2fr 1fr; background: white; border: 1px solid #e2e8f0; box-shadow: 8px 8px 0 var(--brand-800, #1a202c); margin-bottom: 3rem; overflow: hidden; transition: transform 0.2s; }
  .featured-card:hover { transform: translate(-2px, -2px); box-shadow: 10px 10px 0 var(--cta-main, #f97316); }
  .feat-image-wrap { position: relative; height: 100%; min-height: 400px; border-right: 1px solid #e2e8f0; }
  .feat-image-wrap img { width: 100%; height: 100%; object-fit: cover; }
  .category-tag, .category-tag-sm { position: absolute; background: var(--cta-main, #f97316); color: #1a202c; padding: 0.5rem 1rem; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em; }
  .category-tag { top: 1.5rem; left: 1.5rem; }
  .category-tag-sm { bottom: 1rem; left: 1rem; background: #1a202c; color: white; padding: 0.3rem 0.8rem; font-size: 0.7rem; }
  
  .feat-content { padding: 3rem; display: flex; flex-direction: column; justify-content: center; }
  .date, .date-sm { color: #718096; font-weight: 600; margin-bottom: 1rem; display: block; }
  .feat-content h2 { font-size: 2.2rem; line-height: 1.1; margin: 0 0 1.5rem; color: #1a202c; }
  .feat-content p { color: #4a5568; font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem; }

  .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
  .news-card { background: white; border: 1px solid #e2e8f0; box-shadow: 6px 6px 0 #e2e8f0; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
  .news-card:hover { transform: translateY(-4px); box-shadow: 8px 8px 0 var(--cta-main, #f97316); border-color: #1a202c; }
  .card-image-wrap { height: 220px; position: relative; border-bottom: 1px solid #e2e8f0; }
  .card-image-wrap img { width: 100%; height: 100%; object-fit: cover; }
  .card-content { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
  .card-content h3 { font-size: 1.25rem; margin: 0 0 1rem; line-height: 1.3; color: #1a202c; flex: 1; }
  .date-sm { font-size: 0.8rem; margin-bottom: 0.5rem; }

  /* --- BOTONES --- */
  button { font-family: inherit; cursor: pointer; border: none; }
  .read-btn { display: inline-block; background: var(--brand-800, #1a202c); color: white; padding: 1rem 2rem; font-weight: 700; text-transform: uppercase; align-self: flex-start; transition: background 0.2s; }
  .read-btn:hover { background: var(--cta-main, #f97316); color: #1a202c; }
  .read-link { font-weight: 700; text-transform: uppercase; color: #1a202c; background: transparent; border-bottom: 2px solid var(--cta-main, #f97316); align-self: flex-start; font-size: 0.9rem; padding: 0 0 2px 0; }
  .read-link:hover { color: var(--cta-main, #f97316); }

  /* --- MODAL (DIALOG) ESTILOS --- */
  .news-modal {
    margin: auto;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    border: none;
    border-radius: 8px;
    padding: 0;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    background: white;
  }
  .news-modal::backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
  .modal-inner { display: flex; flex-direction: column; position: relative; }
  .close-modal-btn { position: sticky; top: 0; background: var(--brand-800, #1a202c); color: white; padding: 1rem; width: 100%; text-align: right; font-weight: bold; text-transform: uppercase; z-index: 10; border-bottom: 4px solid var(--cta-main, #f97316); }
  .close-modal-btn:hover { background: #e53e3e; }
  .modal-img { width: 100%; height: 350px; object-fit: cover; }
  .modal-body { padding: 3rem; }
  .modal-body h2 { font-size: 2.5rem; margin-bottom: 1.5rem; line-height: 1.2; color: #1a202c; }
  
  /* Estilos para el texto inyectado por Markdown (.prose) */
  .prose { color: #4a5568; line-height: 1.8; font-size: 1.1rem; }
  .prose h2 { font-size: 1.8rem; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
  .prose p { margin-bottom: 1.5rem; }
  .prose ul { margin-bottom: 1.5rem; padding-left: 1.5rem; }
  .prose li { margin-bottom: 0.5rem; }
  .prose a { color: var(--cta-main, #f97316); font-weight: bold; text-decoration: none; }
  .prose a:hover { text-decoration: underline; }

  @media (max-width: 900px) {
    .featured-card { grid-template-columns: 1fr; }
    .feat-image-wrap { min-height: 250px; border-right: none; border-bottom: 1px solid #e2e8f0; }
    .feat-content { padding: 2rem; }
    .feat-content h2 { font-size: 1.8rem; }
    .modal-body { padding: 1.5rem; }
    .modal-body h2 { font-size: 1.8rem; }
    .modal-img { height: 200px; }
  }
</style>